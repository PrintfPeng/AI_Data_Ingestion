<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <title>AI Data Ingestion ‚Äì Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* ‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î */
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö scrollbar ‡πÉ‡∏ô history ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô ‡πÜ */
      .nice-scroll::-webkit-scrollbar {
        width: 8px;
      }

      .nice-scroll::-webkit-scrollbar-track {
        background: transparent;
      }

      .nice-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.8);
        border-radius: 999px;
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-sky-50 via-indigo-50 to-violet-50 text-slate-800"
  >
    <!-- Main container -->
    <div class="min-h-screen flex flex-col">
      <!-- Header -->
      <header class="border-b border-slate-200/70 bg-white/80 backdrop-blur">
        <div class="max-w-7xl mx-auto px-6 lg:px-10 py-4 flex items-center justify-between gap-4">
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
              <span class="text-slate-900">AI</span>
              <span class="text-indigo-500"> Data Ingestion</span>
            </h1>
            <p class="text-sm md:text-base text-slate-600 mt-1">
              ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á <b>Text / Table / Image</b> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π Intent, Sources ‡πÅ‡∏•‡∏∞ History
              ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö ‡πÜ ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            </p>
          </div>

          <div class="hidden md:flex flex-col items-end gap-1">
            <span
              class="inline-flex items-center gap-2 rounded-full bg-emerald-50 text-emerald-700 px-3 py-1 text-xs font-medium border border-emerald-100"
            >
              <span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
              Backend: FastAPI + RAG + Chroma
            </span>
            <span
              class="inline-flex items-center gap-2 rounded-full bg-sky-50 text-sky-700 px-3 py-1 text-xs font-medium border border-sky-100"
            >
              Multi-doc RAG + Intent Routing + Upload
            </span>
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-6 lg:px-10 py-6 lg:py-8">
          <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)] gap-6 xl:gap-8 items-start">
            <!-- LEFT: Upload + Ask -->
            <div class="space-y-6">
              <!-- Upload card -->
              <section
                class="bg-white/90 shadow-lg shadow-slate-200/70 rounded-2xl border border-slate-100/80 p-5 md:p-6"
              >
                <div class="flex items-center justify-between gap-3 mb-4">
                  <div class="flex items-center gap-2">
                    <div
                      class="w-9 h-9 rounded-xl bg-violet-100 text-violet-600 flex items-center justify-center"
                    >
                      üìÑ
                    </div>
                    <div>
                      <h2 class="font-semibold text-lg md:text-xl">
                        ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                      </h2>
                      <p class="text-xs md:text-sm text-slate-500">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô ingestion + cleaning + enrich + index ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                      </p>
                    </div>
                  </div>
                  <span
                    class="hidden sm:inline-flex items-center rounded-full bg-slate-50 border border-slate-200 text-[11px] px-3 py-1 text-slate-500"
                  >
                    Step 1 ¬∑ Upload PDF ‚Üí ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                  </span>
                </div>

                <div class="grid md:grid-cols-[minmax(0,1.3fr)_minmax(0,1fr)] gap-4 md:gap-6">
                  <div class="space-y-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">
                      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF
                    </label>
                    <input
                      id="uploadFile"
                      type="file"
                      accept="application/pdf"
                      class="block w-full text-sm text-slate-700
                             file:mr-4 file:py-2 file:px-4
                             file:rounded-xl file:border-0
                             file:text-sm file:font-semibold
                             file:bg-indigo-50 file:text-indigo-600
                             hover:file:bg-indigo-100
                             cursor-pointer"
                    />
                  </div>

                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-slate-600 mb-1">
                        doc_id (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: doc_001)
                      </label>
                      <input
                        id="uploadDocId"
                        type="text"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-slate-50"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô doc_001"
                      />
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-slate-600 mb-1">
                        doc_type (optional)
                      </label>
                      <input
                        id="uploadDocType"
                        type="text"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-slate-50"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô bank_statement (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)"
                      />
                    </div>
                  </div>
                </div>

                <div class="mt-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                  <button
                    id="uploadBtn"
                    class="inline-flex items-center justify-center px-4 py-2.5 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-violet-500 shadow-sm hover:from-indigo-600 hover:to-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-400"
                  >
                    ‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î + ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                  </button>
                  <p
                    id="uploadStatus"
                    class="text-xs md:text-sm text-slate-500 min-h-[1.5rem]"
                  ></p>
                </div>
              </section>

              <!-- Ask card -->
              <section
                class="bg-white/90 shadow-lg shadow-slate-200/70 rounded-2xl border border-slate-100/80 p-5 md:p-6"
              >
                <div class="flex items-center justify-between gap-3 mb-4">
                  <div class="flex items-center gap-2">
                    <div
                      class="w-9 h-9 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center"
                    >
                      üí¨
                    </div>
                    <div>
                      <h2 class="font-semibold text-lg md:text-xl">
                        ‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                      </h2>
                      <p class="text-xs md:text-sm text-slate-500">
                        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-doc RAG + Intent Routing ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Text / Table
                      </p>
                    </div>
                  </div>
                  <span
                    class="hidden sm:inline-flex items-center rounded-full bg-indigo-50 text-indigo-600 text-[11px] font-medium px-3 py-1 border border-indigo-100"
                  >
                    Multi-doc RAG + Intent Routing
                  </span>
                </div>

                <div class="space-y-4">
                  <!-- Query -->
                  <div>
                    <label
                      class="block text-xs font-medium text-slate-600 mb-1"
                    >
                      ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                    </label>
                    <textarea
                      id="query"
                      class="w-full rounded-2xl border border-slate-200 px-3.5 py-2.5 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 min-h-[80px] resize-y"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"
                    ></textarea>
                  </div>

                  <!-- doc_ids -->
                  <div>
                    <label
                      class="block text-xs font-medium text-slate-600 mb-1"
                    >
                      doc_ids
                      <span class="text-slate-400">
                        (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma, ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏∏‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
                      </span>
                    </label>
                    <input
                      id="doc_ids"
                      type="text"
                      class="w-full rounded-2xl border border-slate-200 px-3.5 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô doc_001,doc_002 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á"
                    />
                  </div>

                  <!-- Mode -->
                  <div>
                    <label
                      class="block text-xs font-medium text-slate-600 mb-2"
                    >
                      ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (source)
                    </label>
                    <div
                      id="modeGroup"
                      class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"
                    >
                      <label
                        class="flex items-center justify-between gap-2 rounded-2xl border border-indigo-200 bg-indigo-50/60 px-3.5 py-2 cursor-pointer"
                      >
                        <span class="flex items-center gap-2">
                          <input
                            type="radio"
                            name="mode"
                            value="auto"
                            checked
                            class="text-indigo-500 focus:ring-indigo-400"
                          />
                          <span class="font-semibold">Auto</span>
                        </span>
                        <span class="text-[11px] text-slate-500">
                          ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏≠‡∏á
                        </span>
                      </label>

                      <label
                        class="flex items-center justify-between gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-2 cursor-pointer"
                      >
                        <span class="flex items-center gap-2">
                          <input
                            type="radio"
                            name="mode"
                            value="text"
                            class="text-indigo-500 focus:ring-indigo-400"
                          />
                          <span class="font-semibold">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Text</span>
                        </span>
                        <span class="text-[11px] text-slate-500">
                          ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢
                        </span>
                      </label>

                      <label
                        class="flex items-center justify-between gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-2 cursor-pointer"
                      >
                        <span class="flex items-center gap-2">
                          <input
                            type="radio"
                            name="mode"
                            value="table"
                            class="text-indigo-500 focus:ring-indigo-400"
                          />
                          <span class="font-semibold">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Table</span>
                        </span>
                        <span class="text-[11px] text-slate-500">
                          ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        </span>
                      </label>

                      <label
                        class="flex items-center justify-between gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-2 cursor-pointer"
                      >
                        <span class="flex items-center gap-2">
                          <input
                            type="radio"
                            name="mode"
                            value="both"
                            class="text-indigo-500 focus:ring-indigo-400"
                          />
                          <span class="font-semibold">Text + Table</span>
                        </span>
                        <span class="text-[11px] text-slate-500">
                          ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- Ask button + Answer -->
                  <div class="pt-1 flex flex-col gap-4">
                    <button
                      id="askBtn"
                      class="inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-2xl text-sm md:text-base font-semibold text-white bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-sky-500 shadow-md hover:from-fuchsia-600 hover:via-indigo-600 hover:to-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-fuchsia-400"
                    >
                      <span>üöÄ</span>
                      <span>‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </button>

                    <div
                      id="result"
                      class="hidden rounded-2xl border border-slate-200 bg-slate-50/80 px-4 py-3 text-sm md:text-base"
                    >
                      <div id="answerText" class="font-medium"></div>
                      <div
                        id="intentText"
                        class="text-xs md:text-sm text-slate-500 mt-1"
                      ></div>
                      <pre
                        id="sources"
                        class="mt-2 text-xs md:text-[13px] text-slate-500 whitespace-pre-line"
                      ></pre>
                    </div>
                  </div>
                </div>
              </section>
            </div>

            <!-- RIGHT: History -->
            <section
              class="bg-white/90 shadow-lg shadow-slate-200/70 rounded-2xl border border-slate-100/80 p-5 md:p-6 h-[520px] xl:h-[560px] flex flex-col"
            >
              <div class="flex items-center justify-between gap-3 mb-3">
                <div class="flex items-center gap-2">
                  <div
                    class="w-8 h-8 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center"
                  >
                    üßæ
                  </div>
                  <div>
                    <h2 class="font-semibold text-lg">History</h2>
                    <p class="text-xs text-slate-500">
                      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Q&A ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏Å‡πà‡∏≤)
                    </p>
                  </div>
                </div>
                <button
                  id="loadHistoryBtn"
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl text-xs font-medium bg-slate-900 text-white hover:bg-slate-800"
                >
                  üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
              </div>

              <div
                id="historyBox"
                class="nice-scroll flex-1 rounded-xl border border-slate-200 bg-slate-50/70 px-3.5 py-3 text-xs md:text-[13px] text-slate-700 overflow-y-auto leading-relaxed whitespace-pre-line"
              ></div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script>
      const askBtn = document.getElementById("askBtn");
      const queryEl = document.getElementById("query");
      const docIdsEl = document.getElementById("doc_ids");
      const resultBox = document.getElementById("result");
      const answerText = document.getElementById("answerText");
      const sourcesEl = document.getElementById("sources");
      const intentText = document.getElementById("intentText");
      const loadHistoryBtn = document.getElementById("loadHistoryBtn");
      const historyBox = document.getElementById("historyBox");

      const uploadBtn = document.getElementById("uploadBtn");
      const uploadFile = document.getElementById("uploadFile");
      const uploadDocId = document.getElementById("uploadDocId");
      const uploadDocType = document.getElementById("uploadDocType");
      const uploadStatus = document.getElementById("uploadStatus");

      function getSelectedMode() {
        const radios = document.querySelectorAll('input[name="mode"]');
        for (const r of radios) {
          if (r.checked) return r.value;
        }
        return "auto";
      }

      async function loadHistory() {
        try {
          historyBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î history...";
          const res = await fetch("/history?limit=20");
          if (!res.ok) {
            historyBox.textContent = `‡πÇ‡∏´‡∏•‡∏î history ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (status ${res.status})`;
            return;
          }
          const data = await res.json();
          if (!data.length) {
            historyBox.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ history";
            return;
          }

          const lines = data.map((item, idx) => {
            const ts = item.ts || "";
            const q = item.query || "";
            const a = item.answer || "";
            const mode = item.mode || "auto";
            const intent = item.intent || "-";
            const docIds =
              item.doc_ids && item.doc_ids.length
                ? item.doc_ids.join(", ")
                : "(‡∏ó‡∏∏‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)";

            return [
              `#${idx + 1} [${ts}]`,
              `mode=${mode}, intent=${intent}`,
              `doc_ids=${docIds}`,
              `Q: ${q}`,
              `A: ${a}`,
            ].join("\n");
          });

          historyBox.textContent = lines.join("\n\n");
        } catch (err) {
          console.error(err);
          historyBox.textContent =
            "‡πÄ‡∏≠‡∏≠‡πÄ‡∏£‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î history ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
        }
      }

      // ---------- Ask RAG ----------
      askBtn.onclick = async () => {
        const query = queryEl.value.trim();
        if (!query) {
          alert("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }

        const rawDocIds = docIdsEl.value.trim();
        let doc_ids = null;
        if (rawDocIds) {
          doc_ids = rawDocIds
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        }

        const mode = getSelectedMode();

        const payload = {
          query,
          doc_ids,
          top_k: 5,
          mode,
        };

        answerText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...";
        intentText.textContent = "";
        sourcesEl.textContent = "";
        resultBox.classList.remove("hidden");
        askBtn.disabled = true;

        try {
          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const msg = `‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /ask ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (status ${res.status})`;
            console.error(msg);
            answerText.textContent = msg;
            return;
          }

          const data = await res.json();
          answerText.textContent = data.answer || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)";

          if (data.intent) {
            intentText.textContent = "Intent: " + data.intent;
          } else {
            intentText.textContent = "";
          }

          if (data.sources && data.sources.length) {
            const lines = data.sources.map(
              (s) =>
                `- doc_id=${s.doc_id}, page=${s.page}, source=${s.source}, chunk_id=${s.chunk_id}`
            );
            sourcesEl.textContent = "Sources:\n" + lines.join("\n");
          } else {
            sourcesEl.textContent = "Sources: (‡πÑ‡∏°‡πà‡∏°‡∏µ)";
          }

          // reload history ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏°
          loadHistory();
        } catch (err) {
          console.error(err);
          answerText.textContent =
            "‡πÄ‡∏≠‡∏≠‡πÄ‡∏£‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /ask ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
          intentText.textContent = "";
          sourcesEl.textContent = "";
        } finally {
          askBtn.disabled = false;
        }
      };

      // ---------- Upload PDF ----------
      uploadBtn.onclick = async () => {
        const file = uploadFile.files[0];
        const docId = uploadDocId.value.trim();
        const docType =
          uploadDocType.value.trim() || "bank_statement";

        if (!file) {
          alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }
        if (!docId) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å doc_id");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("doc_id", docId);
        formData.append("doc_type", docType);

        uploadBtn.disabled = true;
        uploadStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î + ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...";
        uploadStatus.className =
          "text-xs md:text-sm text-slate-600 min-h-[1.5rem]";

        try {
          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const txt = await res.text();
            throw new Error(`status ${res.status}: ${txt}`);
          }

          const data = await res.json();
          uploadStatus.textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß (doc_id=${data.doc_id})`;
          uploadStatus.className =
            "text-xs md:text-sm text-emerald-600 min-h-[1.5rem]";

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á doc_ids ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏±‡∏ö doc ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÜ
          docIdsEl.value = data.doc_id;

          // reload history ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï log ‡∏Å‡∏≤‡∏£ upload
          loadHistory();
        } catch (err) {
          console.error(err);
          uploadStatus.textContent =
            "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
          uploadStatus.className =
            "text-xs md:text-sm text-red-500 min-h-[1.5rem]";
        } finally {
          uploadBtn.disabled = false;
        }
      };

      // ---------- History button ----------
      loadHistoryBtn.onclick = loadHistory;

      // load history ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
      document.addEventListener("DOMContentLoaded", loadHistory);
    </script>
  </body>
</html>
