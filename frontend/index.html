<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <title>AI Data Ingestion ‚Äì Demo</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-sky-100 via-white to-indigo-100 text-slate-900 text-[15px] lg:text-base"
  >
    <!-- ‡πÉ‡∏ä‡πâ w-full ‡πÅ‡∏ó‡∏ô max-w ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ -->
    <div class="w-full px-6 lg:px-12 py-8 lg:py-10">
      <!-- Header -->
      <header
        class="mb-10 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between"
      >
        <div>
          <h1 class="text-3xl lg:text-4xl xl:text-5xl font-bold tracking-tight text-slate-900">
            AI Data Ingestion <span class="text-indigo-600">Demo</span>
          </h1>
          <p class="mt-2 text-sm lg:text-base text-slate-600 max-w-3xl">
            ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á <span class="font-semibold">Text / Table / Image</span>
            ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π Intent, Sources ‡πÅ‡∏•‡∏∞ History ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö ‡πÜ ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          </p>
        </div>
        <div
          class="inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-2 shadow border border-slate-200 text-xs lg:text-sm text-slate-600"
        >
          <span class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span>
          Backend: FastAPI + RAG + Chroma
        </div>
      </header>

      <!-- Main layout: ‡πÉ‡∏ä‡πâ grid ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° + history ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô -->
      <main
        class="grid gap-7 lg:gap-8 lg:grid-cols-[minmax(0,7fr)_minmax(0,6fr)] items-start"
      >
        <!-- Ask Panel -->
        <section
          class="bg-white/95 rounded-3xl shadow-lg border border-slate-100 p-6 lg:p-7 space-y-5"
        >
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xl lg:text-2xl font-semibold text-slate-900">
              üß† ‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            </h2>
            <span
              class="rounded-full bg-indigo-50 px-4 py-1.5 text-xs lg:text-sm font-medium text-indigo-700"
            >
              Multi-doc RAG + Intent Routing
            </span>
          </div>

          <!-- Query -->
          <div>
            <label
              for="query"
              class="block text-sm lg:text-base font-medium text-slate-700 mb-1.5"
              >‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label
            >
            <textarea
              id="query"
              class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-3 text-sm lg:text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"
            ></textarea>
          </div>

          <!-- doc_ids -->
          <div>
            <label
              for="doc_ids"
              class="block text-sm lg:text-base font-medium text-slate-700 mb-1.5"
            >
              doc_ids
              <span class="text-xs font-normal text-slate-500"
                >(‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma, ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏∏‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</span
              >
            </label>
            <input
              id="doc_ids"
              type="text"
              class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-3 text-sm lg:text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô doc_001,doc_002 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á"
            />
          </div>

          <!-- Mode -->
          <div>
            <p class="block text-sm lg:text-base font-medium text-slate-700 mb-2">
              ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (source)
            </p>
            <div
              id="modeGroup"
              class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm lg:text-base"
            >
              <label
                class="flex items-center gap-3 rounded-2xl border border-indigo-200 bg-indigo-50 px-3.5 py-3 cursor-pointer hover:bg-indigo-100"
              >
                <input
                  type="radio"
                  name="mode"
                  value="auto"
                  checked
                  class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"
                />
                <span>
                  <span class="font-medium">Auto</span>
                  <span class="block text-xs text-slate-600"
                    >‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏≠‡∏á</span
                  >
                </span>
              </label>

              <label
                class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-3 cursor-pointer hover:bg-slate-100"
              >
                <input
                  type="radio"
                  name="mode"
                  value="text"
                  class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"
                />
                <span>
                  <span class="font-medium">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Text</span>
                  <span class="block text-xs text-slate-600"
                    >‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢</span
                  >
                </span>
              </label>

              <label
                class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-3 cursor-pointer hover:bg-slate-100"
              >
                <input
                  type="radio"
                  name="mode"
                  value="table"
                  class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"
                />
                <span>
                  <span class="font-medium">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Table</span>
                  <span class="block text-xs text-slate-600"
                    >‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span
                  >
                </span>
              </label>

              <label
                class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-3.5 py-3 cursor-pointer hover:bg-slate-100"
              >
                <input
                  type="radio"
                  name="mode"
                  value="both"
                  class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"
                />
                <span>
                  <span class="font-medium">Text + Table</span>
                  <span class="block text-xs text-slate-600"
                    >‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô</span
                  >
                </span>
              </label>
            </div>
          </div>

          <!-- Button -->
          <div class="pt-1">
            <button
              id="askBtn"
              class="inline-flex items-center gap-2 rounded-2xl bg-indigo-600 px-6 py-3 text-sm lg:text-base font-semibold text-white shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <span>üöÄ ‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </div>

          <!-- Result -->
          <div
            id="result"
            class="mt-3 hidden rounded-2xl border border-slate-100 bg-slate-50/80 p-4 space-y-2"
          >
            <div
              id="answerText"
              class="text-sm lg:text-base text-slate-900 font-medium"
            ></div>
            <div
              id="intentText"
              class="text-xs lg:text-sm text-indigo-700 bg-indigo-50 inline-flex px-3 py-1 rounded-full"
            ></div>
            <div
              id="sources"
              class="text-xs lg:text-sm text-slate-600 whitespace-pre-line"
            ></div>
          </div>
        </section>

        <!-- History Panel -->
        <section
          class="bg-white/95 rounded-3xl shadow-lg border border-slate-100 p-6 lg:p-7 space-y-3"
        >
          <div class="flex items-center justify-between gap-3">
            <h2
              class="text-lg lg:text-xl font-semibold text-slate-900 flex items-center gap-2"
            >
              üìú History
              <span class="text-xs font-normal text-slate-500"
                >(Q&A ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</span
              >
            </h2>
            <button
              id="loadHistoryBtn"
              class="inline-flex items-center gap-1.5 rounded-full bg-slate-900/90 px-3.5 py-1.5 text-xs lg:text-sm font-medium text-white shadow hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-700 focus:ring-offset-2"
            >
              üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
          </div>

          <div
            id="historyBox"
            class="mt-1 max-h-[600px] overflow-y-auto rounded-2xl bg-slate-50/80 px-3.5 py-3 text-xs lg:text-sm text-slate-700 whitespace-pre-line"
          >
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ history
          </div>
        </section>
      </main>
    </div>

    <script>
      const btn = document.getElementById("askBtn");
      const queryEl = document.getElementById("query");
      const docIdsEl = document.getElementById("doc_ids");
      const resultBox = document.getElementById("result");
      const answerText = document.getElementById("answerText");
      const sourcesEl = document.getElementById("sources");
      const intentText = document.getElementById("intentText");
      const loadHistoryBtn = document.getElementById("loadHistoryBtn");
      const historyBox = document.getElementById("historyBox");

      function getSelectedMode() {
        const radios = document.querySelectorAll('input[name="mode"]');
        for (const r of radios) {
          if (r.checked) return r.value;
        }
        return "auto";
      }

      async function loadHistory() {
        try {
          historyBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î history...";
          const res = await fetch("/history?limit=20");
          if (!res.ok) {
            historyBox.textContent = `‡πÇ‡∏´‡∏•‡∏î history ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (status ${res.status})`;
            return;
          }
          const data = await res.json();
          if (!data.length) {
            historyBox.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ history";
            return;
          }

          const lines = data.map((item, idx) => {
            const ts = item.ts || "";
            const q = item.query || "";
            const a = item.answer || "";
            const mode = item.mode || "auto";
            const intent = item.intent || "-";

            const docIds =
              item.doc_ids && item.doc_ids.length
                ? item.doc_ids.join(", ")
                : "(‡∏ó‡∏∏‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)";

            return [
              `#${idx + 1} [${ts}]`,
              `  mode=${mode}, intent=${intent}`,
              `  doc_ids=${docIds}`,
              `  Q: ${q}`,
              `  A: ${a}`,
            ].join("\n");
          });

          historyBox.textContent = lines.join("\n\n");
        } catch (err) {
          console.error(err);
          historyBox.textContent =
            "‡πÄ‡∏≠‡∏≠‡πÄ‡∏£‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î history ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
        }
      }

      btn.onclick = async () => {
        const query = queryEl.value.trim();
        if (!query) {
          alert("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }

        const rawDocIds = docIdsEl.value.trim();
        let doc_ids = null;
        if (rawDocIds) {
          doc_ids = rawDocIds
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        }

        const mode = getSelectedMode();

        const payload = {
          query,
          doc_ids,
          top_k: 5,
          mode,
        };

        answerText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...";
        if (intentText) intentText.textContent = "";
        sourcesEl.textContent = "";
        resultBox.classList.remove("hidden");
        btn.disabled = true;

        try {
          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const msg = `‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /ask ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (status ${res.status})`;
            console.error(msg);
            answerText.textContent = msg;
            return;
          }

          const data = await res.json();

          answerText.textContent = data.answer || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)";

          if (intentText) {
            if (data.intent) {
              intentText.textContent = "Intent: " + data.intent;
            } else {
              intentText.textContent = "";
            }
          }

          if (data.sources && data.sources.length) {
            const lines = data.sources.map(
              (s) =>
                `- doc_id=${s.doc_id}, page=${s.page}, source=${s.source}, chunk_id=${s.chunk_id}`
            );
            sourcesEl.textContent = "Sources:\n" + lines.join("\n");
          } else {
            sourcesEl.textContent = "Sources: (‡πÑ‡∏°‡πà‡∏°‡∏µ)";
          }

          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î history ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          loadHistory();
        } catch (err) {
          console.error(err);
          answerText.textContent =
            "‡πÄ‡∏≠‡∏≠‡πÄ‡∏£‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /ask ‡∏î‡∏π console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
          if (intentText) intentText.textContent = "";
          sourcesEl.textContent = "";
        } finally {
          btn.disabled = false;
        }
      };

      // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä history
      loadHistoryBtn.onclick = () => {
        loadHistory();
      };

      // ‡πÇ‡∏´‡∏•‡∏î history ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      loadHistory();
    </script>
  </body>
</html>
